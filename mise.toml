[tools]
java = 'temurin-21'
"github:google/copybara" = { version = "v20260112", asset_pattern = "copybara_deploy.jar", bin = "copybara" }
go = "1.25.5"
gh = "2.38.0"

[shell_alias]
copybara = "java -jar $(mise which copybara)"

[settings]
http_retries = 3
pin = true

[tasks.mirror]
description = "Run copybara workflow and tidy go.mod for a provider"
run = '''
#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 2 ]; then
  echo "Usage: mise run mirror <provider> <tag|major> [upstream_repo]"
  echo "Examples:"
  echo "  mise run mirror aws v5.85.0"
  echo "  mise run mirror aws 6 https://github.com/hashicorp/terraform-provider-aws.git"
  exit 1
fi

PROVIDER="$1"
ARG2="$2"
UPSTREAM_REPO="${3:-}"

# Auto-detect mode: explicit tag vs major version discovery
if [[ "$ARG2" =~ ^v([0-9]+)\. ]]; then
  # Explicit tag mode (backward compatible)
  TAG="$ARG2"
  MAJOR="${BASH_REMATCH[1]}"
  echo "==> Explicit tag mode: TAG=$TAG, MAJOR=$MAJOR"

  WORKFLOW="mirror_${PROVIDER}_v${MAJOR}"
  MIRROR_DIR="mirrors/${PROVIDER}/v${MAJOR}"

  # Check if this is the first migration for this provider/major version
  INIT_FLAG=""
  if ! git tag -l "${PROVIDER}/v${MAJOR}/*" | grep -q .; then
    echo "First migration for ${PROVIDER} v${MAJOR}, adding --init-history flag"
    INIT_FLAG="--init-history"
  else
    echo "Found existing migrations for ${PROVIDER} v${MAJOR}"
  fi

  TEMP_BRANCH="mirror-${PROVIDER}-v${MAJOR}"
  FINAL_BRANCH="mirror-${PROVIDER}-v${MAJOR}-${TAG}"

  echo "Running copybara workflow: $WORKFLOW with TAG=$TAG"
  java -jar $(mise which copybara) copy.bara.sky "$WORKFLOW" "$TAG" $INIT_FLAG

  echo "Fetching and renaming branch to $FINAL_BRANCH"
  git fetch origin "$TEMP_BRANCH"
  git checkout -B "$FINAL_BRANCH" "origin/$TEMP_BRANCH"

  echo "Running go mod tidy in $MIRROR_DIR"
  cd "$MIRROR_DIR"
  go mod tidy
  cd - >/dev/null

  echo "Committing go mod tidy changes"
  git add "$MIRROR_DIR/go.mod" "$MIRROR_DIR/go.sum"
  if ! git diff --cached --quiet; then
    git commit -m "Run go mod tidy for $TAG"
  fi

  echo "Pushing to $FINAL_BRANCH"
  git push origin "$FINAL_BRANCH"

  echo "==> Mirror complete!"

elif [[ "$ARG2" =~ ^[0-9]+$ ]]; then
  # Major version discovery mode (for CI)
  MAJOR="$ARG2"

  if [ -z "$UPSTREAM_REPO" ]; then
    echo "Error: upstream_repo is required for discovery mode"
    echo "Usage: mise run mirror <provider> <major> <upstream_repo>"
    exit 1
  fi

  echo "==> Discovery mode: PROVIDER=$PROVIDER, MAJOR=$MAJOR, UPSTREAM=$UPSTREAM_REPO"

  # Discover latest tag for this major version
  echo "Finding latest v${MAJOR}.* tag from upstream..."
  TAG=$(git ls-remote --tags "$UPSTREAM_REPO" \
    | awk -F/ '{print $NF}' \
    | grep "^v${MAJOR}\." \
    | grep -v '\^{}' \
    | sort -V \
    | tail -n1)

  if [ -z "$TAG" ]; then
    echo "No tags found matching v${MAJOR}.*"
    exit 0
  fi

  echo "Found latest tag: $TAG"

  # Check if tag is already mirrored
  if git rev-parse "refs/tags/${PROVIDER}/v${MAJOR}/${TAG}" >/dev/null 2>&1; then
    echo "Tag $TAG is already mirrored. Nothing to do."
    exit 0
  fi

  echo "Tag $TAG is new. Starting mirror process..."

  # Run copybara
  WORKFLOW="mirror_${PROVIDER}_v${MAJOR}"
  MIRROR_DIR="mirrors/${PROVIDER}/v${MAJOR}"

  # Check if this is the first migration for this provider/major version
  INIT_FLAG=""
  if ! git tag -l "${PROVIDER}/v${MAJOR}/*" | grep -q .; then
    echo "First migration for ${PROVIDER} v${MAJOR}, adding --init-history flag"
    INIT_FLAG="--init-history"
  else
    echo "Found existing migrations for ${PROVIDER} v${MAJOR}"
  fi

  TEMP_BRANCH="mirror-${PROVIDER}-v${MAJOR}"
  FINAL_BRANCH="mirror-${PROVIDER}-v${MAJOR}-${TAG}"

  echo "Running copybara workflow: $WORKFLOW with TAG=$TAG"
  java -jar $(mise which copybara) copy.bara.sky "$WORKFLOW" "$TAG" $INIT_FLAG

  echo "Fetching and renaming branch to $FINAL_BRANCH"
  git fetch origin "$TEMP_BRANCH"
  git checkout -B "$FINAL_BRANCH" "origin/$TEMP_BRANCH"

  echo "Running go mod tidy in $MIRROR_DIR"
  cd "$MIRROR_DIR"
  go mod tidy
  cd - >/dev/null

  echo "Committing go mod tidy changes"
  git add "$MIRROR_DIR/go.mod" "$MIRROR_DIR/go.sum"
  if ! git diff --cached --quiet; then
    git commit -m "Run go mod tidy for $TAG"
  fi

  echo "Pushing to $FINAL_BRANCH"
  git push origin "$FINAL_BRANCH"

  # Create PR
  echo "Creating pull request..."
  BRANCH="mirror/${PROVIDER}/v${MAJOR}/${TAG}"
  TITLE="Mirror ${PROVIDER} v${MAJOR} ${TAG}"
  BODY="Automated mirror of ${PROVIDER} ${TAG} from upstream.

Source: ${UPSTREAM_REPO}
Tag: ${TAG}

This PR includes:
- Provider code from upstream
- Applied patches from providers/${PROVIDER}/v${MAJOR}/patches/
- Updated go.mod with tidied dependencies"

  gh pr create \
    --title "$TITLE" \
    --body "$BODY" \
    --base main \
    --head "$BRANCH"

  # Enable auto-merge
  echo "Enabling auto-merge..."
  gh pr merge --auto --squash

  echo "==> Mirror and PR creation complete!"

else
  echo "Error: Invalid second argument: $ARG2"
  echo "Expected either a tag (e.g., v5.85.0) or a major version (e.g., 5 or 6)"
  exit 1
fi
'''
